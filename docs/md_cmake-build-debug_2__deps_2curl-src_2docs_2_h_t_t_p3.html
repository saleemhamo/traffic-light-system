<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.10.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CrossGuard: HTTP3 (and QUIC)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CrossGuard
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.10.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">HTTP3 (and QUIC)</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md1092"></a> </p>
<h1><a class="anchor" id="autotoc_md1093"></a>
Resources</h1>
<p><a href="https://http3-explained.haxx.se/en/">HTTP/3 Explained</a> - the online free book describing the protocols involved.</p>
<p><a href="https://quicwg.org/">quicwg.org</a> - home of the official protocol drafts</p>
<h1><a class="anchor" id="autotoc_md1094"></a>
QUIC libraries</h1>
<p>QUIC libraries we are experimenting with:</p>
<p><a href="https://github.com/ngtcp2/ngtcp2">ngtcp2</a></p>
<p><a href="https://github.com/cloudflare/quiche">quiche</a></p>
<p><a href="https://github.com/nibanks/msh3">msh3</a> (with <a href="https://github.com/microsoft/msquic">msquic</a>)</p>
<h1><a class="anchor" id="autotoc_md1095"></a>
Experimental</h1>
<p>HTTP/3 and QUIC support in curl is considered <b>EXPERIMENTAL</b> until further notice. It needs to be enabled at build-time.</p>
<p>Further development and tweaking of the HTTP/3 support in curl will happen in the master branch using pull-requests, just like ordinary changes.</p>
<p>To fix before we remove the experimental label:</p>
<ul>
<li>the used QUIC library needs to consider itself non-beta</li>
<li>it's fine to "leave" individual backends as experimental if necessary</li>
</ul>
<h1><a class="anchor" id="autotoc_md1096"></a>
ngtcp2 version</h1>
<p>Building curl with ngtcp2 involves 3 components: <code>ngtcp2</code> itself, <code>nghttp3</code> and a QUIC supporting TLS library. The supported TLS libraries are covered below.</p>
<p>For now, <code>ngtcp2</code> and <code>nghttp3</code> are still <em>experimental</em> which means their evolution bring breaking changes. Therefore, the proper version of both libraries need to be used when building curl. These are</p>
<ul>
<li><code>ngtcp2</code>: v0.19.1</li>
<li><code>nghttp3</code>: v0.15.0</li>
</ul>
<h2><a class="anchor" id="autotoc_md1097"></a>
Build with OpenSSL</h2>
<p>Build (patched) OpenSSL </p><pre class="fragment"> % git clone --depth 1 -b openssl-3.0.10+quic https://github.com/quictls/openssl
 % cd openssl
 % ./config enable-tls1_3 --prefix=&lt;somewhere1&gt;
 % make
 % make install
</pre><p> Build nghttp3 </p><pre class="fragment"> % cd ..
 % git clone -b v0.15.0 https://github.com/ngtcp2/nghttp3
 % cd nghttp3
 % autoreconf -fi
 % ./configure --prefix=&lt;somewhere2&gt; --enable-lib-only
 % make
 % make install
</pre><p> Build ngtcp2 </p><pre class="fragment"> % cd ..
 % git clone -b v0.19.1 https://github.com/ngtcp2/ngtcp2
 % cd ngtcp2
 % autoreconf -fi
 % ./configure PKG_CONFIG_PATH=&lt;somewhere1&gt;/lib/pkgconfig:&lt;somewhere2&gt;/lib/pkgconfig LDFLAGS="-Wl,-rpath,&lt;somewhere1&gt;/lib" --prefix=&lt;somewhere3&gt; --enable-lib-only
 % make
 % make install
</pre><p> Build curl </p><pre class="fragment"> % cd ..
 % git clone https://github.com/curl/curl
 % cd curl
 % autoreconf -fi
 % LDFLAGS="-Wl,-rpath,&lt;somewhere1&gt;/lib" ./configure --with-openssl=&lt;somewhere1&gt; --with-nghttp3=&lt;somewhere2&gt; --with-ngtcp2=&lt;somewhere3&gt;
 % make
 % make install
</pre><p> For OpenSSL 3.0.0 or later builds on Linux for x86_64 architecture, substitute all occurrences of "/lib" with "/lib64"</p>
<h2><a class="anchor" id="autotoc_md1098"></a>
Build with GnuTLS</h2>
<p>Build GnuTLS </p><pre class="fragment"> % git clone --depth 1 https://gitlab.com/gnutls/gnutls.git
 % cd gnutls
 % ./bootstrap
 % ./configure --prefix=&lt;somewhere1&gt;
 % make
 % make install
</pre><p> Build nghttp3 </p><pre class="fragment"> % cd ..
 % git clone -b v0.15.0 https://github.com/ngtcp2/nghttp3
 % cd nghttp3
 % autoreconf -fi
 % ./configure --prefix=&lt;somewhere2&gt; --enable-lib-only
 % make
 % make install
</pre><p> Build ngtcp2 </p><pre class="fragment"> % cd ..
 % git clone -b v0.19.1 https://github.com/ngtcp2/ngtcp2
 % cd ngtcp2
 % autoreconf -fi
 % ./configure PKG_CONFIG_PATH=&lt;somewhere1&gt;/lib/pkgconfig:&lt;somewhere2&gt;/lib/pkgconfig LDFLAGS="-Wl,-rpath,&lt;somewhere1&gt;/lib" --prefix=&lt;somewhere3&gt; --enable-lib-only --with-gnutls
 % make
 % make install
</pre><p> Build curl </p><pre class="fragment"> % cd ..
 % git clone https://github.com/curl/curl
 % cd curl
 % autoreconf -fi
 % ./configure --with-gnutls=&lt;somewhere1&gt; --with-nghttp3=&lt;somewhere2&gt; --with-ngtcp2=&lt;somewhere3&gt;
 % make
 % make install
</pre> <h2><a class="anchor" id="autotoc_md1099"></a>
Build with wolfSSL</h2>
<p>Build wolfSSL </p><pre class="fragment"> % git clone https://github.com/wolfSSL/wolfssl.git
 % cd wolfssl
 % autoreconf -fi
 % ./configure --prefix=&lt;somewhere1&gt; --enable-quic --enable-session-ticket --enable-earlydata --enable-psk --enable-harden --enable-altcertchains
 % make
 % make install
</pre><p> Build nghttp3 </p><pre class="fragment"> % cd ..
 % git clone -b v0.15.0 https://github.com/ngtcp2/nghttp3
 % cd nghttp3
 % autoreconf -fi
 % ./configure --prefix=&lt;somewhere2&gt; --enable-lib-only
 % make
 % make install
</pre><p> Build ngtcp2 </p><pre class="fragment"> % cd ..
 % git clone -b v0.19.1 https://github.com/ngtcp2/ngtcp2
 % cd ngtcp2
 % autoreconf -fi
 % ./configure PKG_CONFIG_PATH=&lt;somewhere1&gt;/lib/pkgconfig:&lt;somewhere2&gt;/lib/pkgconfig LDFLAGS="-Wl,-rpath,&lt;somewhere1&gt;/lib" --prefix=&lt;somewhere3&gt; --enable-lib-only --with-wolfssl
 % make
 % make install
</pre><p> Build curl </p><pre class="fragment"> % cd ..
 % git clone https://github.com/curl/curl
 % cd curl
 % autoreconf -fi
 % ./configure --with-wolfssl=&lt;somewhere1&gt; --with-nghttp3=&lt;somewhere2&gt; --with-ngtcp2=&lt;somewhere3&gt;
 % make
 % make install
</pre> <h1><a class="anchor" id="autotoc_md1100"></a>
quiche version</h1>
<p>Since the quiche build manages its dependencies, curl can be built against the latest version. You are <em>probably</em> able to build against their main branch, but in case of problems, we recommend their latest release tag.</p>
<h2><a class="anchor" id="autotoc_md1101"></a>
build</h2>
<p>Build quiche and BoringSSL: </p><pre class="fragment"> % git clone --recursive https://github.com/cloudflare/quiche
 % cd quiche
 % cargo build --package quiche --release --features ffi,pkg-config-meta,qlog
 % mkdir quiche/deps/boringssl/src/lib
 % ln -vnf $(find target/release -name libcrypto.a -o -name libssl.a) quiche/deps/boringssl/src/lib/
</pre><p> Build curl: </p><pre class="fragment"> % cd ..
 % git clone https://github.com/curl/curl
 % cd curl
 % autoreconf -fi
 % ./configure LDFLAGS="-Wl,-rpath,$PWD/../quiche/target/release" --with-openssl=$PWD/../quiche/quiche/deps/boringssl/src --with-quiche=$PWD/../quiche/target/release
 % make
 % make install
</pre><p> If <code>make install</code> results in <code>Permission denied</code> error, you will need to prepend it with <code>sudo</code>.</p>
<h1><a class="anchor" id="autotoc_md1102"></a>
msh3 (msquic) version</h1>
<p><b>Note</b>: The msquic HTTP/3 backend is immature and is not properly functional one as of September 2023. Feel free to help us test it and improve it, but there is no point in filing bugs about it just yet.</p>
<h2><a class="anchor" id="autotoc_md1103"></a>
Build Linux (with quictls fork of OpenSSL)</h2>
<p>Build msh3: </p><pre class="fragment"> % git clone -b v0.6.0 --depth 1 --recursive https://github.com/nibanks/msh3
 % cd msh3 &amp;&amp; mkdir build &amp;&amp; cd build
 % cmake -G 'Unix Makefiles' -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
 % cmake --build .
 % cmake --install .
</pre><p> Build curl: </p><pre class="fragment"> % git clone https://github.com/curl/curl
 % cd curl
 % autoreconf -fi
 % ./configure LDFLAGS="-Wl,-rpath,/usr/local/lib" --with-msh3=/usr/local --with-openssl
 % make
 % make install
</pre><p> Run from <code>/usr/local/bin/curl</code>.</p>
<h2><a class="anchor" id="autotoc_md1104"></a>
Build Windows</h2>
<p>Build msh3: </p><pre class="fragment"> % git clone -b v0.6.0 --depth 1 --recursive https://github.com/nibanks/msh3
 % cd msh3 &amp;&amp; mkdir build &amp;&amp; cd build
 % cmake -G 'Visual Studio 17 2022' -DCMAKE_BUILD_TYPE=RelWithDebInfo ..
 % cmake --build . --config Release
 % cmake --install . --config Release
</pre><p> <b>Note</b> - On Windows, Schannel will be used for TLS support by default. If you with to use (the quictls fork of) OpenSSL, specify the <code>-DQUIC_TLS=openssl</code> option to the generate command above. Also note that OpenSSL brings with it an additional set of build dependencies not specified here.</p>
<p>Build curl (in <a href="../winbuild/README.md#open-a-command-prompt">Visual Studio Command prompt</a>): </p><pre class="fragment"> % git clone https://github.com/curl/curl
 % cd curl/winbuild
 % nmake /f Makefile.vc mode=dll WITH_MSH3=dll MSH3_PATH="C:/Program Files/msh3" MACHINE=x64
</pre><p> <b>Note</b> - If you encounter a build error with <code>tool_hugehelp.c</code> being missing, rename <code>tool_hugehelp.c.cvs</code> in the same directory to <code>tool_hugehelp.c</code> and then run <code>nmake</code> again.</p>
<p>Run in the <code>C:/Program Files/msh3/lib</code> directory, copy <code>curl.exe</code> to that directory, or copy <code>msquic.dll</code> and <code>msh3.dll</code> from that directory to the <code>curl.exe</code> directory. For example: </p><pre class="fragment"> % C:\Program Files\msh3\lib&gt; F:\curl\builds\libcurl-vc-x64-release-dll-ipv6-sspi-schannel-msh3\bin\curl.exe --http3 https://curl.se/
</pre> <h1><a class="anchor" id="autotoc_md1105"></a>
<code>--http3</code></h1>
<p>Use only HTTP/3: </p><pre class="fragment">curl --http3-only https://example.org:4433/
</pre><p> Use HTTP/3 with fallback to HTTP/2 or HTTP/1.1 (see "HTTPS eyeballing" below): </p><pre class="fragment">curl --http3 https://example.org:4433/
</pre><p> Upgrade via Alt-Svc: </p><pre class="fragment">curl --alt-svc altsvc.cache https://curl.se/
</pre><p> See this <a href="https://bagder.github.io/HTTP3-test/">list of public HTTP/3 servers</a></p>
<h3><a class="anchor" id="autotoc_md1106"></a>
HTTPS eyeballing</h3>
<p>With option <code>--http3</code> curl will attempt earlier <a class="el" href="struct_h_t_t_p.html">HTTP</a> versions as well should the connect attempt via HTTP/3 not succeed "fast enough". This strategy is similar to IPv4/6 happy eyeballing where the alternate address family is used in parallel after a short delay.</p>
<p>The IPv4/6 eyeballing has a default of 200ms and you may override that via <code>--happy-eyeballs-timeout-ms value</code>. Since HTTP/3 is still relatively new, we decided to use this timeout also for the <a class="el" href="struct_h_t_t_p.html">HTTP</a> eyeballing - with a slight twist.</p>
<p>The <code>happy-eyeballs-timeout-ms</code> value is the <b>hard</b> timeout, meaning after that time expired, a TLS connection is opened in addition to negotiate HTTP/2 or HTTP/1.1. At half of that value - currently - is the <b>soft</b> timeout. The soft timeout fires, when there has been <b>no data at all</b> seen from the server on the HTTP/3 connection.</p>
<p>So, without you specifying anything, the hard timeout is 200ms and the soft is 100ms:</p>
<ul>
<li>Ideally, the whole QUIC handshake happens and curl has an HTTP/3 connection in less than 100ms.</li>
<li>When QUIC is not supported (or UDP does not work for this network path), no reply is seen and the HTTP/2 TLS+TCP connection starts 100ms later.</li>
<li>In the worst case, UDP replies start before 100ms, but drag on. This will start the TLS+TCP connection after 200ms.</li>
<li>When the QUIC handshake fails, the TLS+TCP connection is attempted right away. For example, when the QUIC server presents the wrong certificate.</li>
</ul>
<p>The whole transfer only fails, when <b>both</b> QUIC and TLS+TCP fail to handshake or time out.</p>
<p>Note that all this happens in addition to IP version happy eyeballing. If the name resolution for the server gives more than one IP address, curl will try all those until one succeeds - just as with all other protocols. And if those IP addresses contain both IPv6 and IPv4, those attempts will happen, delayed, in parallel (the actual eyeballing).</p>
<h2><a class="anchor" id="autotoc_md1107"></a>
Known Bugs</h2>
<p>Check out the <a href="https://curl.se/docs/knownbugs.html#HTTP3">list of known HTTP3 bugs</a>.</p>
<h1><a class="anchor" id="autotoc_md1108"></a>
HTTP/3 Test server</h1>
<p>This is not advice on how to run anything in production. This is for development and experimenting.</p>
<h2><a class="anchor" id="autotoc_md1109"></a>
Prerequisite(s)</h2>
<p>An existing local HTTP/1.1 server that hosts files. Preferably also a few huge ones. You can easily create huge local files like <code>truncate -s=8G 8GB</code> - they are huge but do not occupy that much space on disk since they are just big holes.</p>
<p>In a Debian setup you can install <b>apache2</b>. It runs on port 80 and has a document root in <code>/var/www/html</code>. Download the 8GB file from apache with <code>curl localhost/8GB -o dev/null</code></p>
<p>In this description we setup and run an HTTP/3 reverse-proxy in front of the HTTP/1 server.</p>
<h2><a class="anchor" id="autotoc_md1110"></a>
Setup</h2>
<p>You can select either or both of these server solutions.</p>
<h3><a class="anchor" id="autotoc_md1111"></a>
nghttpx</h3>
<p>Get, build and install <b>quictls</b>, <b>nghttp3</b> and <b>ngtcp2</b> as described above.</p>
<p>Get, build and install <b>nghttp2</b>: </p><pre class="fragment">git clone https://github.com/nghttp2/nghttp2.git
cd nghttp2
autoreconf -fi
PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/home/daniel/build-quictls/lib/pkgconfig:/home/daniel/build-nghttp3/lib/pkgconfig:/home/daniel/build-ngtcp2/lib/pkgconfig  LDFLAGS=-L/home/daniel/build-quictls/lib CFLAGS=-I/home/daniel/build-quictls/include ./configure --enable-maintainer-mode --prefix=/home/daniel/build-nghttp2 --disable-shared --enable-app --enable-http3 --without-jemalloc --without-libxml2 --without-systemd
make &amp;&amp; make install
</pre><p> Run the local h3 server on port 9443, make it proxy all traffic through to HTTP/1 on localhost port 80. For local toying, we can just use the test cert that exists in curl's test dir. </p><pre class="fragment">CERT=$CURLSRC/tests/stunnel.pem
$HOME/bin/nghttpx $CERT $CERT --backend=localhost,80 \
  --frontend="localhost,9443;quic"
</pre> <h3><a class="anchor" id="autotoc_md1112"></a>
Caddy</h3>
<p><a href="https://caddyserver.com/docs/install">Install Caddy</a>. For easiest use, the binary should be either in your PATH or your current directory.</p>
<p>Create a <code>Caddyfile</code> with the following content: </p><div class="fragment"><div class="line">localhost:7443 {</div>
<div class="line">  respond &quot;Hello, world! you are using {http.request.proto}&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><p>Then run Caddy: </p><pre class="fragment">./caddy start
</pre><p> Making requests to <code><a href="https://localhost:7443">https://localhost:7443</a></code> should tell you which protocol is being used.</p>
<p>You can change the hard-coded response to something more useful by replacing <code>respond</code> with <code>reverse_proxy</code> or <code>file_server</code>, for example: <code>reverse_proxy localhost:80</code> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.10.0
</small></address>
</body>
</html>
